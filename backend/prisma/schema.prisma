// Schema Prisma optimise pour SQLite
// Compatible avec toutes les bases de donnees

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// Modeles sans enums (compatible SQLite)

model User {
  id              String    @id @default(uuid())
  email           String    @unique
  username        String    @unique
  password        String
  firstName       String
  lastName        String
  phone           String?
  phoneLabel      String?   // Mobile, Travail, Domicile, etc.
  secondaryPhone  String?
  secondaryPhoneLabel String?
  avatar          String?
  role            String    @default("USER") // ADMIN, MANAGER, SALES, USER
  isActive        Boolean   @default(true)
  isContact       Boolean   @default(false) // true = contact simple, false = utilisateur
  
  // Champs additionnels pour le profil
  company         String?
  jobTitle        String?   // Fonction/poste
  website         String?   // Site web
  secondaryEmail  String?   // Email secondaire
  address         String?
  city            String?
  country         String?
  postalCode      String?
  birthDate       DateTime? // Date de naissance
  labels          String?   // √âtiquettes/tags (JSON array)
  bio             String?   // Notes
  
  // 2FA
  twoFactorEnabled Boolean  @default(false)
  twoFactorSecret  String?
  chatRecentEmojis String?  // JSON array des emojis r√©cents du chat
  chatLastSeenAt   DateTime? // Derni√®re activit√© chat pour pr√©sence en ligne/hors ligne
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  assignedLeads   Lead[]    @relation("AssignedTo")
  assignedProjects ProjectMember[]
  assignedTasks   Task[]    @relation("AssignedTo")
  createdTasks    Task[]    @relation("CreatedBy")
  notionPages     NotionPage[]
  notes           Note[]
  activities      Activity[]
  notificationSettings NotificationSettings?
  
  // Relations pour contacts (champs multiples)
  contactEmails   ContactEmail[]
  contactPhones   ContactPhone[]
  contactAddresses ContactAddress[]
  contactWebsites ContactWebsite[]
  contactDates    ContactDate[]
  contactRelations ContactRelation[]
  contactCustomFields ContactCustomField[]
  
  // Relations pour le chat
  conversationMemberships ConversationMember[]
  sentMessages    Message[] @relation("SentMessages")
  deletedMessages Message[] @relation("DeletedMessages")
  messageEditHistory MessageEditHistory[] @relation("EditedBy")
  hiddenMessages  MessageHidden[]
  blockedUsers    UserBlock[] @relation("Blocker")
  blockedByUsers  UserBlock[] @relation("Blocked")
  
  // Relations pour le calendrier
  events          Event[]   @relation("UserEvents")
  
  // Relations pour QR Codes
  qrCodes         QrCode[]
  
  // Relations pour PDF Tools
  pdfMergeProjects PdfMergeProject[] @relation("PdfMergeProjects")
  
  // Relations pour CV
  experiences     Experience[] @relation("UserExperiences")
  education       Education[] @relation("UserEducation")
  trainings       Training[] @relation("UserTrainings")
  certificates    Certificate[] @relation("UserCertificates")
  volunteers      Volunteer[] @relation("UserVolunteers")
  cvProjects      CvProject[] @relation("UserCvProjects")
  skills          Skill[] @relation("UserSkills")

  @@map("users")
}

// Mod√®le pour stocker les QR Codes sauvegard√©s
model QrCode {
  id              String    @id @default(uuid())
  userId          String
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  name            String    // Nom du QR code (ex: "Menu Restaurant", "Contact Pro")
  type            String    // Type: link, text, email, call, sms, vcard, whatsapp, wifi, pdf, app, images, video, social, event, barcode2d
  settings        String    // JSON contenant form + design (complet)
  thumbnail       String?   // URL miniature du QR (optionnel)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@map("qr_codes")
  @@index([userId])
}

// Tables pour champs multiples des contacts

model ContactEmail {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  email     String
  label     String   @default("Travail") // Travail, Personnel, Autre
  isPrimary Boolean  @default(false)
  createdAt DateTime @default(now())
  
  @@map("contact_emails")
}

model ContactPhone {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  phone     String
  label     String   @default("Mobile") // Mobile, Travail, Domicile, Principal, Autre
  isPrimary Boolean  @default(false)
  createdAt DateTime @default(now())
  
  @@map("contact_phones")
}

model ContactAddress {
  id         String   @id @default(uuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  label      String   @default("Domicile") // Domicile, Travail, Autre
  street     String?
  city       String?
  state      String?
  postalCode String?
  country    String?
  isPrimary  Boolean  @default(false)
  createdAt  DateTime @default(now())
  
  @@map("contact_addresses")
}

model ContactWebsite {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  url       String
  label     String   @default("Site Web") // Site Web, Blog, Profil, Accueil, Travail, Autre
  createdAt DateTime @default(now())
  
  @@map("contact_websites")
}

model ContactDate {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  date      DateTime
  label     String   @default("Anniversaire") // Anniversaire, √âv√©nement, Autre
  createdAt DateTime @default(now())
  
  @@map("contact_dates")
}

model ContactRelation {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  name      String
  label     String   @default("Contact") // Conjoint, Enfant, Parent, Manager, Assistant, Partenaire, Autre
  createdAt DateTime @default(now())
  
  @@map("contact_relations")
}

model ContactCustomField {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  fieldName String
  value     String
  createdAt DateTime @default(now())
  
  @@map("contact_custom_fields")
}

model Customer {
  id              String    @id @default(uuid())
  companyName     String
  contactName     String
  email           String    @unique
  phone           String?
  website         String?
  address         String?
  city            String?
  country         String?
  zipCode         String?
  taxId           String?
  notes           String?
  isActive        Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  leads           Lead[]
  projects        Project[]
  invoices        Invoice[]

  @@map("customers")
}

model Lead {
  id              String      @id @default(uuid())
  title           String
  description     String?
  companyName     String
  contactName     String
  email           String
  phone           String?
  value           Float?      // Utiliser Float au lieu de Decimal pour SQLite
  status          String      @default("NEW") // NEW, CONTACTED, QUALIFIED, PROPOSAL, NEGOTIATION, WON, LOST
  source          String?
  expectedCloseDate DateTime?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  // Relations
  customerId      String?
  customer        Customer?   @relation(fields: [customerId], references: [id])
  assignedToId    String?
  assignedTo      User?       @relation("AssignedTo", fields: [assignedToId], references: [id])
  notes           Note[]
  activities      Activity[]

  @@map("leads")
}

model Project {
  id              String        @id @default(uuid())
  name            String
  description     String?
  startDate       DateTime?
  endDate         DateTime?
  budget          Float?        // Float au lieu de Decimal
  status          String        @default("PLANNING") // PLANNING, IN_PROGRESS, ON_HOLD, COMPLETED, CANCELLED
  progress        Int           @default(0)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  // Relations
  customerId      String
  customer        Customer      @relation(fields: [customerId], references: [id])
  members         ProjectMember[]
  tasks           Task[]
  invoices        Invoice[]
  notes           Note[]
  activities      Activity[]

  @@map("projects")
}

model ProjectMember {
  id              String    @id @default(uuid())
  role            String?
  joinedAt        DateTime  @default(now())

  // Relations
  projectId       String
  project         Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  userId          String
  user            User      @relation(fields: [userId], references: [id])

  @@unique([projectId, userId])
  @@map("project_members")
}

model Task {
  id              String        @id @default(uuid())
  title           String
  description     String?
  status          String        @default("TODO") // TODO, IN_PROGRESS, REVIEW, COMPLETED, CANCELLED
  priority        String        @default("MEDIUM") // LOW, MEDIUM, HIGH, URGENT
  dueDate         DateTime?
  estimatedHours  Float?        // Float au lieu de Decimal
  actualHours     Float?        // Float au lieu de Decimal
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  // Relations
  projectId       String?
  project         Project?      @relation(fields: [projectId], references: [id])
  assignedToId    String?
  assignedTo      User?         @relation("AssignedTo", fields: [assignedToId], references: [id])
  createdById     String
  createdBy       User          @relation("CreatedBy", fields: [createdById], references: [id])
  notes           Note[]
  activities      Activity[]

  @@map("tasks")
}

model NotionPage {
  id              String    @id @default(uuid())
  title           String    @default("Untitled")
  icon            String    @default("üìù")
  blocksJson      String
  ownerId         String
  owner           User      @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([ownerId, updatedAt])
  @@map("notion_pages")
}

model Invoice {
  id              String        @id @default(uuid())
  invoiceNumber   String        @unique
  issueDate       DateTime      @default(now())
  dueDate         DateTime
  subtotal        Float         // Float au lieu de Decimal
  tax             Float         @default(0)
  discount        Float         @default(0)
  total           Float
  status          String        @default("DRAFT") // DRAFT, SENT, PAID, OVERDUE, CANCELLED
  notes           String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  // Relations
  customerId      String
  customer        Customer      @relation(fields: [customerId], references: [id])
  projectId       String?
  project         Project?      @relation(fields: [projectId], references: [id])
  items           InvoiceItem[]

  @@map("invoices")
}

model InvoiceItem {
  id              String    @id @default(uuid())
  description     String
  quantity        Float     // Float au lieu de Decimal
  unitPrice       Float
  total           Float

  // Relations
  invoiceId       String
  invoice         Invoice   @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@map("invoice_items")
}

model Note {
  id              String    @id @default(uuid())
  content         String
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  userId          String
  user            User      @relation(fields: [userId], references: [id])
  customerId      String?
  leadId          String?
  lead            Lead?     @relation(fields: [leadId], references: [id])
  projectId       String?
  project         Project?  @relation(fields: [projectId], references: [id])
  taskId          String?
  task            Task?     @relation(fields: [taskId], references: [id])

  @@map("notes")
}

model Activity {
  id              String    @id @default(uuid())
  type            String    // "created", "updated", "deleted", "status_changed", etc.
  description     String
  metadata        String?   // JSON en String pour SQLite
  createdAt       DateTime  @default(now())

  // Relations
  userId          String
  user            User      @relation(fields: [userId], references: [id])
  leadId          String?
  lead            Lead?     @relation(fields: [leadId], references: [id])
  projectId       String?
  project         Project?  @relation(fields: [projectId], references: [id])
  taskId          String?
  task            Task?     @relation(fields: [taskId], references: [id])

  @@map("activities")
}

// Table pour les parametres du systeme
model Setting {
  id              String    @id @default(uuid())
  key             String    @unique
  value           String
  type            String    @default("string") // string, number, boolean, json
  category        String?   // general, email, finance, etc.
  description     String?
  updatedAt       DateTime  @updatedAt

  @@map("settings")
}

// Preferences de notification par utilisateur
model NotificationSettings {
  id              String    @id @default(uuid())
  
  // Preferences
  emailNotifications Boolean @default(true)
  taskNotifications  Boolean @default(true)
  leadNotifications  Boolean @default(true)
  projectNotifications Boolean @default(true)
  newsletter         Boolean @default(false)
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  userId          String    @unique
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notification_settings")
}

// ============================================
// CHAT - Syst√®me de messagerie
// ============================================

// Conversations (1-√†-1 ou groupes)
model Conversation {
  id              String    @id @default(uuid())
  type            String    @default("DIRECT") // DIRECT ou GROUP
  title           String?   // Nom du groupe (uniquement pour les groupes)
  description     String?   // Description du groupe
  avatar          String?   // Avatar du groupe
  createdById     String    // Cr√©ateur de la conversation
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  lastMessageAt   DateTime? // Date du dernier message (pour tri)
  
  // Relations
  members         ConversationMember[]
  messages        Message[]

  @@map("conversations")
}

// Membres d'une conversation (relation many-to-many)
model ConversationMember {
  id              String    @id @default(uuid())
  conversationId  String
  userId          String
  joinedAt        DateTime  @default(now())
  isAdmin         Boolean   @default(false) // Pour les groupes
  notificationsMuted Boolean @default(false)
  leftAt          DateTime? // Date de d√©part (si quitt√©)
  
  // Relations
  conversation    Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([conversationId, userId])
  @@map("conversation_members")
}

// Messages
model Message {
  id              String    @id @default(uuid())
  conversationId  String
  senderId        String
  content         String
  type            String    @default("TEXT") // TEXT, IMAGE, FILE, SYSTEM
  attachmentUrl   String?   // URL du fichier joint
  isRead          Boolean   @default(false)
  isEdited        Boolean   @default(false)
  editedAt        DateTime?
  deletedForEveryone Boolean @default(false)
  deletedAt       DateTime?
  deletedById     String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  // Relations
  conversation    Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender          User      @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)
  deletedBy       User?     @relation("DeletedMessages", fields: [deletedById], references: [id], onDelete: SetNull)
  editHistory     MessageEditHistory[]
  hiddenFor       MessageHidden[]
  
  @@map("messages")
}

model MessageEditHistory {
  id              String    @id @default(uuid())
  messageId       String
  editorId        String
  previousContent String
  newContent      String
  editedAt        DateTime  @default(now())

  message         Message   @relation(fields: [messageId], references: [id], onDelete: Cascade)
  editor          User      @relation("EditedBy", fields: [editorId], references: [id], onDelete: Cascade)

  @@index([messageId])
  @@map("message_edit_history")
}

model MessageHidden {
  id              String    @id @default(uuid())
  messageId       String
  userId          String
  hiddenAt        DateTime  @default(now())

  message         Message   @relation(fields: [messageId], references: [id], onDelete: Cascade)
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([messageId, userId])
  @@index([userId])
  @@map("message_hidden")
}

model UserBlock {
  id              String    @id @default(uuid())
  blockerId       String
  blockedId       String
  createdAt       DateTime  @default(now())

  blocker         User      @relation("Blocker", fields: [blockerId], references: [id], onDelete: Cascade)
  blocked         User      @relation("Blocked", fields: [blockedId], references: [id], onDelete: Cascade)

  @@unique([blockerId, blockedId])
  @@index([blockerId])
  @@index([blockedId])
  @@map("user_blocks")
}

// Calendar Events
model Event {
  id              String    @id @default(uuid())
  title           String
  description     String?
  startDate       DateTime
  endDate         DateTime
  allDay          Boolean   @default(false)
  location        String?
  type            String    @default("EVENT") // EVENT, MEETING, CALL, TASK, REMINDER, LUNCH
  color           String    @default("primary") // primary, success, info, warning, danger
  userId          String
  reminder        Int?      // Minutes avant l'√©v√©nement (15, 30, 60, etc.)
  isRecurring     Boolean   @default(false)
  recurrenceRule  String?   // DAILY, WEEKLY, MONTHLY, YEARLY
  attendees       String?   // JSON array des participants
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  // Relations
  user            User      @relation("UserEvents", fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([startDate])
  @@map("events")
}

// Mod√®le pour sauvegarder les projets de fusion PDF
model PdfMergeProject {
  id              String    @id @default(uuid())
  userId          String
  name            String    // Nom du projet
  description     String?   // Description optionnelle
  filesData       String    // JSON contenant les infos des fichiers (nom, pageCount, selectedPages, ordre)
  filesDirectory  String    // R√©pertoire contenant les fichiers upload√©s
  totalFiles      Int       // Nombre de fichiers
  totalPages      Int       // Nombre total de pages s√©lectionn√©es
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  // Relations
  user            User      @relation("PdfMergeProjects", fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([createdAt])
  @@map("pdf_merge_projects")
}

// ========================================
// MOD√àLES POUR LE CV
// ========================================

// Exp√©riences professionnelles
model Experience {
  id              String    @id @default(uuid())
  userId          String
  user            User      @relation("UserExperiences", fields: [userId], references: [id], onDelete: Cascade)
  
  title           String    // Titre du poste
  company         String    // Nom de l'entreprise
  location        String?   // Ville, Pays
  employmentType  String?   // CDI, CDD, Freelance, Stage, Alternance
  startDate       DateTime  // Date de d√©but
  endDate         DateTime? // Date de fin (null si poste actuel)
  isCurrent       Boolean   @default(false) // Poste actuel
  description     String?   // Description des t√¢ches et r√©alisations
  skills          String?   // Comp√©tences utilis√©es (JSON array)
  achievements    String?   // R√©alisations cl√©s (JSON array)
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@index([userId])
  @@index([startDate])
  @@map("experiences")
}

// √âtudes et formations acad√©miques
model Education {
  id              String    @id @default(uuid())
  userId          String
  user            User      @relation("UserEducation", fields: [userId], references: [id], onDelete: Cascade)
  
  degree          String    // Dipl√¥me (Licence, Master, Doctorat, etc.)
  fieldOfStudy    String    // Domaine d'√©tudes
  school          String    // √âtablissement
  location        String?   // Ville, Pays
  startDate       DateTime  // Date de d√©but
  endDate         DateTime? // Date de fin (null si en cours)
  isCurrent       Boolean   @default(false) // √âtudes en cours
  grade           String?   // Mention ou note
  description     String?   // Description, m√©moire, projets
  activities      String?   // Activit√©s extra-scolaires (JSON array)
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@index([userId])
  @@index([startDate])
  @@map("education")
}

// Formations continues et certifications courtes
model Training {
  id              String    @id @default(uuid())
  userId          String
  user            User      @relation("UserTrainings", fields: [userId], references: [id], onDelete: Cascade)
  
  name            String    // Nom de la formation
  organization    String    // Organisme de formation
  instructor      String?   // Formateur/instructeur
  duration        String?   // Dur√©e (ex: "40 heures", "3 jours")
  completionDate  DateTime? // Date de fin
  description     String?   // Description du contenu
  skills          String?   // Comp√©tences acquises (JSON array)
  url             String?   // Lien vers le cours/certificat
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@index([userId])
  @@index([completionDate])
  @@map("trainings")
}

// Certificats professionnels
model Certificate {
  id              String    @id @default(uuid())
  userId          String
  user            User      @relation("UserCertificates", fields: [userId], references: [id], onDelete: Cascade)
  
  name            String    // Nom du certificat
  issuingOrg      String    // Organisme √©metteur
  issueDate       DateTime  // Date d'obtention
  expiryDate      DateTime? // Date d'expiration (null si pas d'expiration)
  credentialId    String?   // ID de certification
  credentialUrl   String?   // URL de v√©rification
  description     String?   // Description
  fileUrl         String?   // Fichier PDF/image du certificat
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@index([userId])
  @@index([issueDate])
  @@map("certificates")
}

// Exp√©riences b√©n√©voles
model Volunteer {
  id              String    @id @default(uuid())
  userId          String
  user            User      @relation("UserVolunteers", fields: [userId], references: [id], onDelete: Cascade)
  
  role            String    // R√¥le/titre
  organization    String    // Organisation
  cause           String?   // Cause (ex: "√âducation", "Environnement")
  location        String?   // Lieu
  startDate       DateTime  // Date de d√©but
  endDate         DateTime? // Date de fin (null si en cours)
  isCurrent       Boolean   @default(false) // B√©n√©volat en cours
  description     String?   // Description des activit√©s
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@index([userId])
  @@index([startDate])
  @@map("volunteers")
}

// Projets personnels/professionnels
model CvProject {
  id              String    @id @default(uuid())
  userId          String
  user            User      @relation("UserCvProjects", fields: [userId], references: [id], onDelete: Cascade)
  
  name            String    // Nom du projet
  role            String?   // R√¥le dans le projet
  description     String    // Description d√©taill√©e
  technologies    String?   // Technologies utilis√©es (JSON array)
  url             String?   // Lien vers le projet
  githubUrl       String?   // Lien GitHub
  startDate       DateTime? // Date de d√©but
  endDate         DateTime? // Date de fin (null si en cours)
  isCurrent       Boolean   @default(false) // Projet en cours
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@index([userId])
  @@index([startDate])
  @@map("cv_projects")
}

// Comp√©tences
model Skill {
  id              String    @id @default(uuid())
  userId          String
  user            User      @relation("UserSkills", fields: [userId], references: [id], onDelete: Cascade)
  
  name            String    // Nom de la comp√©tence
  category        String    // Cat√©gorie (Technique, Linguistique, Soft Skills, etc.)
  level           String?   // Niveau (D√©butant, Interm√©diaire, Avanc√©, Expert)
  yearsOfExp      Int?      // Ann√©es d'exp√©rience
  endorsements    Int       @default(0) // Nombre de recommandations
  description     String?   // Description
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@index([userId])
  @@index([category])
  @@map("skills")
}

// ========================================
// MOD√àLES POUR LE CV
// ========================================

// Exp√©riences professionnelles
